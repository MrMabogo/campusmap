{% extends 'maps/base.html' %}
{% load socialaccount %}
{% block homeactive %}nav-link {% endblock %}
{% block mapactive %}nav-link active{% endblock %}
{% block content %}
<h1>Home Map</h1>

<div id="instructions"></div>
    <div class='heading'>
        <h1>Our locations</h1>
    </div>
    <div id='listings' class='listings'></div>

     //mapboxgl.accessToken = 'pk.eyJ1IjoiYm1ib2dvIiwiYSI6ImNrbWUzaG9qNjJyazMyd29qMGxrbHZvd2sifQ.oG0-1XdG-OAeNRxL0Vwz6g';

<div id='map' width="100%" style='height:50em'></div>
<script type="text/javascript">
     mapboxgl.accessToken = '{{mapbox_access_token}}'; //renders django view variable
     var map = new mapboxgl.Map({
       container: 'map',
       center: [-78.512, 38.036],
       minZoom: 12,
       style: 'mapbox://styles/mapbox/streets-v11'
     });


     var SaveControl = L.Control.extend({
        container: null,
        saveBtn: null,
        loadBtn: null,
        originPlaceholder: "Choose a starting place",
        destPlaceholder: "Choose destination",
        route: null,
        onAdd: function(map) {
            this.container = L.DomUtil.create('div', 'save-control bg-white mt-1');

            let btnGrp = L.DomUtil.create('div', 'button-group', this.container);
            btnGrp.setAttribute('role', 'group')
            this.saveBtn = L.DomUtil.create('button', 'btn bg-info text-white');
            this.saveBtn.setAttribute('type', 'button');
            this.saveBtn.innerHTML = 'Save route';

            this.loadBtn = L.DomUtil.create('button', 'btn bg-secondary text-white');
            this.loadBtn.setAttribute('type', 'button');
            this.loadBtn.innerHTML = 'Load route';

            btnGrp.appendChild(this.saveBtn);
            btnGrp.appendChild(this.loadBtn);

            return this.container;
        },

        onRemove: function() {
            this.getContainer().parentNode.removeChild(getContainer());
        },

        getTextInput: function(head, placeholder) {
            var ret = null;
            var inputs = head.querySelectorAll("input");
            for(let i = 0; i<inputs.length; i++)
            {
                if(inputs[i].placeholder == placeholder && inputs[i].type == "text") 
                {
                    ret = inputs[i];
                    break;
                }
            }

            return ret;
        },

        getRadioInput: function(head, name) {
            let ret = null;
            let inputs = head.querySelectorAll("input");
            for(let i = 0; i<inputs.length; i++)
            {
                if(inputs[i].name == name && inputs[i].type == "radio" && inputs[i].checked) 
                {
                    ret = inputs[i];
                    break;
                }
            }

    function buildLocationList(data) {
         data.features.forEach(function(facility, i){
             /**
              * Create a shortcut for `facility.properties`,
              * which will be used several times below.
              **/
             var prop = facility.properties;

             /* Add a new listing section to the sidebar. */
             var listings = document.getElementById('listings');
             var listing = listings.appendChild(document.createElement('div'));
             /* Assign a unique `id` to the listing. */
             listing.id = "listing-" + data.features[i].properties.id;
             /* Assign the `item` class to each listing for styling. */
             listing.className = 'item';

             /* Add the link to the individual listing created above. */
             var link = listing.appendChild(document.createElement('a'));
             link.href = '#';
             link.className = 'title';
             link.id = "link-" + prop.id;
             link.innerHTML = prop.address;

             /* Add details to the individual listing. */
             var details = listing.appendChild(document.createElement('div'));
             details.innerHTML = prop.name;
             /* if (prop.phone) {
                 details.innerHTML += ' Â· ' + prop.phoneFormatted;
             }
             if (prop.distance) {
                 var roundedDistance = Math.round(prop.distance * 100) / 100;
                 details.innerHTML +=
                     '<p><strong>' + roundedDistance + ' miles away</strong></p>';
             } */
             link.addEventListener('click', function(e){
                 for (var i = 0; i < data.features.length; i++) {
                     if (this.id === "link-" + data.features[i].properties.id) {
                         var clickedListing = data.features[i];
                         map.flyTo({
                             center: clickedListing.geometry.coordinates,
                             zoom: 15
                         });
                         //createPopUp(clickedListing);
                     }
                 }
                 var activeItem = document.getElementsByClassName('active');
                 if (activeItem[0]) {
                     activeItem[0].classList.remove('active');
                 }
                 this.parentNode.classList.add('active');
             });
         });
     }

     function setupMap(center) {
         var map = new mapboxgl.Map({
           container: 'map',
           center: center,
           zoom: 12,
           style: 'mapbox://styles/mapbox/streets-v11'
         })

        // zoom and compass stuff
         var nav = new mapboxgl.NavigationControl(); // https://docs.mapbox.com/mapbox-gl-js/example/navigation/
         map.addControl(nav);

         // geocoder that should bias search results to UVA area
         let geocoder = new MapboxGeocoder({ // https://docs.mapbox.com/help/tutorials/local-search-geocoding-api/
                 accessToken: mapboxgl.accessToken,
                 mapboxgl: mapboxgl,
                 marker: false,
                 bbox: [-79, 37, -78, 39], // boundary box for Charlottesville
                 proximity: center // bias results to favor ones closer to location
         });

         // map.addControl(geocoder, 'bottom-right');


         var directions = new MapboxDirections({ // https://github.com/mapbox/mapbox-gl-directions
             accessToken: mapboxgl.accessToken,
             geocoder: geocoder
         });
         // puts the search boxes in the top left corner
         map.addControl(directions, 'top-left');
         map.on('load', function (e){  // https://docs.mapbox.com/help/tutorials/building-a-store-locator/
             map.addSource('UVA', {
                type: 'geojson',
                data: 'https://gist.githubusercontent.com/hudsonburke/7ce0e2657f3c5e22244a10c2cc0e9c6f/raw/7a4e8eefbf0d1b10321e1b13ea254e868ec7ad22/geo_facilities.json' // 'https://jsonkeeper.com/b/0BK4'
             });
             //while(!map.isSourceLoaded('UVA')){}; // makes sure that the source finishes loading before moving on

             let facilities = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [
                                -78.5034,
                                38.0356
                            ]
                        },
                        "properties": {
                            "name": "ROTUNDA",
                            "address": "1826  University Ave",
                            "category": "Office"
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [
                                -78.5099,
                                38.0329
                            ]
                        },
                        "properties": {
                            "name": "THORNTON HALL",
                            "address": "351  McCormick Rd",
                            "category": "Office"
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [
                                null,
                                null
                            ]
                        },
                        "properties": {
                            "name": "RICE HALL",
                            "address": "85  Engineers Way",
                            "category": "Research"
                        }
                    }
                ]
            }; // map.getSource('UVA');

             // give each facility an id
             facilities.features.forEach(function (facility, i){
                 facility.properties.id = i;
             });
             // add them to the map
             map.addLayer({
                'id' : 'locations',
                'type' : 'circle',
                'source' : {
                    'type' : 'geojson',
                    'data' : facilities
                }
            });

             buildLocationList(facilities);

            /* For each feature in the GeoJSON object above: */
             facilities.features.forEach(function (marker) {
                 /* Create a div element for the marker. */
                 var el = document.createElement('div');
                 /* Assign a unique `id` to the marker. */
                 el.id = 'marker-' + marker.properties.id;
                 /* Assign the `marker` class to each marker for styling. */
                 el.className = 'marker';

                 /**
                  * Create a marker using the div element
                  * defined above and add it to the map.
                  **/
                 new mapboxgl.Marker(el, {offset: [0, -23]})
                     .setLngLat(marker.geometry.coordinates)
                     .addTo(map);

                 /**
                  * Listen to the element and when it is clicked, do three things:
                  * 1. Fly to the point
                  * 2. Close all other popups and display popup for clicked store
                  * 3. Highlight listing in sidebar (and remove highlight for all other listings)
                  **/
                 el.addEventListener('click', function (e) {
                     /* Fly to the point */
                     map.flyTo({
                         center: marker.geometry.coordinates,
                         zoom: 15
                     });
                     /* Close all other popups and display popup for clicked store */
                     // createPopUp(marker);
                     /* Highlight listing in sidebar */
                     var activeItem = document.getElementsByClassName('active');
                     e.stopPropagation();
                     if (activeItem[0]) {
                         activeItem[0].classList.remove('active');
                     }
                     var listing = document.getElementById(
                         'listing-' + marker.properties.id
                     );
                     listing.classList.add('active');
                 });
             });
        });

            return ret;
        },

        setup: function() {
            this.container.parentNode.children[0].children[0].appendChild(this.container); //really ugly, sorry
            let start = this.getTextInput(this.container.parentNode, this.originPlaceholder);
            let end = this.getTextInput(this.container.parentNode, this.destPlaceholder);
            let controller = this;
            let dirProfile = controller.getRadioInput(controller.container.parentNode, "profile").value;

            this.saveBtn.addEventListener('click', function(e) {
                let startLatLn = start.value.split(',');
                let endLatLn = end.value.split(',');
                dirProfile = controller.getRadioInput(controller.container.parentNode, "profile").value;
                console.log('clicked');
                if(startLatLn.length > 1 && endLatLn.length > 1)
                {
                    var url = 'https://api.mapbox.com/directions/v5/'+dirProfile+'/' + startLatLn[0] + ',' + startLatLn[1] + ';' + endLatLn[0] +
                        ',' + endLatLn[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;

                    var req = new XMLHttpRequest();
                    req.open('GET', url, true);
                    req.onload = function() {
                        var json = JSON.parse(req.response);
                        var data = json.routes[0];
                        controller.route = data;
                        console.log("requested");

                        /*This is supposed to send the route HTTP request to the django view 
                        var formData = new FormData();
                        let btnParent = controller.container;
                        btnParent.innerHTML = '{% csrf_token %}' + btnParent.innerHTML;
                        var csrf = btnParent.children[0];
                        formData.append(csrf.name, csrf.value);
                        formData.append('coords', JSON.stringify(data));
                        formData.append('persist_type', 'Save route');
                        fetch('{% url "maps:persist" %}', {
                            method: 'POST',
                            body: formData
                        }).then(res => res.json).then(res => console.log(res));*/
                    }
                    req.send()
                }
            })

            this.loadBtn.addEventListener('click', function(e) {
                console.log('clicked2');
                if(controller.route)
                {
                    /*This is supposed to send the route HTTP request to the django view
                    var formData = new FormData();
                    let btnParent = controller.container;
                    btnParent.innerHTML = '{% csrf_token %}' + btnParent.innerHTML;
                    var csrf = btnParent.children[0];
                    formData.append(csrf.name, csrf.value);
                    formData.append('persist_type', 'Load route');
                    fetch('{% url "maps:persist" %}', {
                        method: 'POST',
                        body: formData
                    }).then(res => res.json).then(res => console.log(res));*/
                    getRoute(controller.route);

                    let legs = controller.route.geometry.coordinates.length
                    let startCoord = controller.route.geometry.coordinates[0]
                    let endCoord = controller.route.geometry.coordinates[legs-1]
                    var point1 = {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'Point',
                                coordinates: startCoord
                            }
                        }
                        ]
                    };

                    var point2 = {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'Point',
                                coordinates: endCoord
                            }
                        }
                        ]
                    };

                    if(map.getLayer('start-saved'))
                    {
                        map.getSource('start-saved').setData(point1);
                    } else {
                        map.addLayer({
                            id: 'start-saved',
                            type: 'circle',
                            source: {
                                type: 'geojson',
                                data: {
                                    type: 'FeatureCollection',
                                    features: [{
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'Point',
                                            coordinates: startCoord
                                        }
                                    }
                                    ]
                                }
                            },
                            paint: {
                                'circle-radius': 10,
                                'circle-color': '#3887be'
                            }
                        });
                    }

                    if(map.getLayer('end-saved'))
                    {
                        map.getSource('end-saved').setData(point2);
                    } else {
                        map.addLayer({
                            id: 'end-saved',
                            type: 'circle',
                            source: {
                                type: 'geojson',
                                data: {
                                    type: 'FeatureCollection',
                                    features: [{
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'Point',
                                            coordinates: endCoord
                                        }
                                    }
                                    ]
                                }
                            },
                            paint: {
                                'circle-radius': 10,
                                'circle-color': '#422244'
                            }
                        });
                    }
                }
            })
        }
    });
    var nav = new mapboxgl.NavigationControl();
    map.addControl(nav);
    var directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
    });

    var saver = new SaveControl();
    map.addControl(directions, 'top-left');
    map.addControl(saver, 'top-left');
    saver.setup();
    function getRoute(saved) {
        var geojson = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: saved.geometry.coordinates
                }
        };
        if (map.getSource('route')) {
                map.getSource('route').setData(geojson);
        } else {
            map.addLayer({
                id: 'route',
                type: 'line',
                source: {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: geojson
                        }
                    }
                },
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#429400',
                    'line-width': 10,
                    'line-opacity': 0.9
                }
            });
        }

    }

</script>
{% endblock %}
</body>
</html>