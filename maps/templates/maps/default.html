{% extends 'maps/base.html' %}
{% block content %}
<h1>Home Map</h1>
<div id='map' width="100%" style='height:45em'></div>
<div id="instructions"></div>
<script>
     mapboxgl.accessToken = 'pk.eyJ1IjoiYm1ib2dvIiwiYSI6ImNrbWUzaG9qNjJyazMyd29qMGxrbHZvd2sifQ.oG0-1XdG-OAeNRxL0Vwz6g';
     var map = new mapboxgl.Map({
       container: 'map',
       center: [-78.512, 38.036],
       minZoom: 12,
       style: 'mapbox://styles/mapbox/streets-v11'
     });

     var canvas = map.getCanvasContainer();
     var start = [-78.512, 38.036]; // this will change once we accept user input
     function getRoute(end) {
         var start = [-78.512, 38.036]; // this will change once we accept user input
         var url = 'https://api.mapbox.com/directions/v5/mapbox/walking/' + start[0] + ',' + start[1] + ';' + end[0] +
             ',' + end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;

         // make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
         var req = new XMLHttpRequest();
         req.open('GET', url, true);
         req.onload = function() {
             var json = JSON.parse(req.response);
             var data = json.routes[0];
             var route = data.geometry.coordinates;
             var geojson = {
                 type: 'Feature',
                 properties: {},
                 geometry: {
                     type: 'LineString',
                     coordinates: route
                 }
             };
             // if the route already exists on the map, reset it using setData
             if (map.getSource('route')) {
                 map.getSource('route').setData(geojson);
             } else { // otherwise, make a new request
                 map.addLayer({
                     id: 'route',
                     type: 'line',
                     source: {
                         type: 'geojson',
                         data: {
                             type: 'Feature',
                             properties: {},
                             geometry: {
                                 type: 'LineString',
                                 coordinates: geojson
                             }
                         }
                     },
                     layout: {
                         'line-join': 'round',
                         'line-cap': 'round'
                     },
                     paint: {
                         'line-color': '#3887be',
                         'line-width': 5,
                         'line-opacity': 0.75
                     }
                 });
             }
             // get the sidebar and add the instructions
             var instructions = document.getElementById('instructions');
             var steps = data.legs[0].steps;

             var tripInstructions = [];
             for (var i = 0; i < steps.length; i++) {
                 tripInstructions.push('<br><li>' + steps[i].maneuver.instruction) + '</li>';
                 instructions.innerHTML = '<br><span class="duration">Trip duration: ' + Math.floor(data.duration / 60) + ' min </span>' + tripInstructions;
             }
         };
         req.send();
     }

     map.on('load', function() {
         // make an initial directions request that
         // starts and ends at the same location
         getRoute(start);

         // Add starting point to the map
         map.addLayer({
             id: 'point',
             type: 'circle',
             source: {
                 type: 'geojson',
                 data: {
                     type: 'FeatureCollection',
                     features: [{
                         type: 'Feature',
                         properties: {},
                         geometry: {
                             type: 'Point',
                             coordinates: start
                         }
                     }
                     ]
                 }
             },
             paint: {
                 'circle-radius': 10,
                 'circle-color': '#3887be'
             }
         });
         map.on('click', function(e) {
             var coordsObj = e.lngLat;
             canvas.style.cursor = '';
             var coords = Object.keys(coordsObj).map(function(key) {
                 return coordsObj[key];
             });
             var end = {
                 type: 'FeatureCollection',
                 features: [{
                     type: 'Feature',
                     properties: {},
                     geometry: {
                         type: 'Point',
                         coordinates: coords
                     }
                 }
                 ]
             };
             if (map.getLayer('end')) {
                 map.getSource('end').setData(end);
             } else {
                 map.addLayer({
                     id: 'end',
                     type: 'circle',
                     source: {
                         type: 'geojson',
                         data: {
                             type: 'FeatureCollection',
                             features: [{
                                 type: 'Feature',
                                 properties: {},
                                 geometry: {
                                     type: 'Point',
                                     coordinates: coords
                                 }
                             }]
                         }
                     },
                     paint: {
                         'circle-radius': 10,
                         'circle-color': '#f30'
                     }
                 });
             }
             getRoute(coords);
         });
     });

</script>
{% endblock %}
</body>
</html>
