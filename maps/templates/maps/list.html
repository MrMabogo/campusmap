{% extends 'maps/base.html' %}
{% load socialaccount %}
{% block homeactive %}nav-link {% endblock %}
{% block mapactive %}nav-link{% endblock %}
{% block recommendationsactive %}nav-link{% endblock %}
{% block recommendationslistactive %}nav-link active{% endblock %}
{% block content %}

<head>
     <style>
        div.small_indent
        {
            margin-left: 2%;
        }
        div.med_indent
        {
            margin-left: 5%;
        }
        div.large_indent
        {
            margin-left: 10%;
        }
        div.spacer
        {
          padding-top: 10px;
          padding-bottom: 10px
        }

    </style>
</head>

<div class="spacer"></div>
<div class="text-center">
    <h1>Recommendations Forum</h1>
</div>
<br>

{% if latest_recommendations_list %}
    <!--<ul class="list-group">-->
    <div class="container">
    {% for recommendation in latest_recommendations_list %}
        <div class="row justify-content-md-center">
            <div class="col col-lg bg-light m-1">
                <p> 
                    <span class="text-capitalize font-weight-bold">{{ recommendation.location_name }}</span>
                    <span class="text-capitalize">{{ recommendation.address }}</span>
                </p>
                <p> 
                    {{ recommendation.details }}
                </p>
                <form action="{% url 'maps:update_recommendation' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="name" value="{{ recommendation.location_name }}">
                    <input type="hidden" name="author" value="{{ recommendation.author.username }}">
                    <div class="btn-group">
                        <button class="btn bg-success text-white btn-sm like-btn" type="button" name="update_type" value="like">
                        like <span class="badge badge-light">{{ recommendation.likes|length }}</span>
                        </button>
                    </div>
                </form>
                
                <div class="comments-section m-1">
                    <div>
                        <form>
                            {% csrf_token %}
                            <input type="hidden" name="name" value="{{ recommendation.location_name }}">
                            <input type="hidden" name="author" value="{{ recommendation.author.username }}">
                            <textarea class="md-textarea form-control ml-0 mb-2" name="comment" style="resize: none" maxlength="140" placeholder="Share your thoughts! In 140 characters..."></textarea>
                            <button class="btn btn-secondary btn-sm comment-btn" type="submit" name="update_type" value="comment">
                                Post
                            </button>
                        </form>
                    </div>
                    <a class="comments-toggle text-decoration-none" href="#" id="dropdownMenuButton">
                        Comments
                    </a>
                    <div class="comments bg-primary" style="display: none">
                        {% if recommendation.comment_set.all %}
                        {% for comment in recommendation.comment_set.all %}
                        <div> 
                            <p>
                                <span class="text-capitalize font-weight-bold">{{ comment.author.username }}</span>
                                <span class="text-capitalize ">{{ comment.post_date }}</span>
                            </p>
                            <p class="font-weight-normal">{{ comment }}</span> <!-- this might be an issue
                        </div>
                        {% endfor %}
                        {% else %}
                            <p>No comments here...</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
    <script type="text/javascript">
        $(".like-btn").click(function (e) {
            e.preventDefault();

            var csrf = $(this.parentNode.parentNode).find('[name="csrfmiddlewaretoken"]');
            var recName = $(this.parentNode.parentNode).find('[name="name"]');
            var recAuthor = $(this.parentNode.parentNode).find('[name="author"]');

            var formData = new FormData();
            formData.append(csrf.prop("name"), csrf.prop("value"));
            formData.append(recName.prop("name"), recName.prop("value"));
            formData.append(recAuthor.prop("name"), recAuthor.prop("value"));
            formData.append("update_type", "like");

            fetch("{% url 'maps:update_recommendation' %}", {
                method: "POST",
                body: formData
            }).then(res => res.json()).then(res => {
                if(res["update_status"] == "liked") {
                    $(this).find("span").html(res["likes"]);
                }
            });
        });

        $(".comments-toggle").click(function (e) {
            e.preventDefault();

            var comments = $(this.parentNode).find(".comments");
            //toggle comment visibility
            if(comments.css("display") == "none")
            {
                comments.css("display", "unset");
            } else {
                comments.css("display", "none");
            }
        })
    </script>
    </ul>-->
{% else %}
    <p>No recommendations have been written.</p>
{% endif %}
<br><br><br><br><br>

{% endblock %}
</body>
</html>